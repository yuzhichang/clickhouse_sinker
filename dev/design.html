<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Architecture | clickhouse_sinker</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="clickhouse_sinker a tool to sink the data into ClickHouse">
    
    <link rel="preload" href="/clickhouse_sinker/assets/css/0.styles.c8126bef.css" as="style"><link rel="preload" href="/clickhouse_sinker/assets/js/app.8e568c59.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/3.8923746e.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/11.fb719bcf.js" as="script"><link rel="prefetch" href="/clickhouse_sinker/assets/js/10.d0214e85.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/12.19470d1a.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/13.62f9e5e3.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/14.12a1bdc4.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/15.f3b1a098.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/4.87857d03.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/5.aa25d793.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/6.3d1e31b7.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/7.aa05d2d9.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/8.77ddf78e.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/9.26ac0101.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/vendors~docsearch.4d3f31fb.js">
    <link rel="stylesheet" href="/clickhouse_sinker/assets/css/0.styles.c8126bef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clickhouse_sinker/" class="home-link router-link-active"><!----> <span class="site-name">clickhouse_sinker</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Development</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clickhouse_sinker/dev/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/clickhouse_sinker/dev/design.html" aria-current="page" class="active sidebar-link">Design</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/design.html#sharding" class="sidebar-link">Sharding</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/design.html#task-scheduling" class="sidebar-link">Task scheduling</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h1> <h2 id="sharding"><a href="#sharding" class="header-anchor">#</a> Sharding</h2> <p>clickhouse_sinker guarantee:</p> <ul><li>at-least-once</li> <li>Duplicated messages (per topic-partition-offset) are routed to the same ClickHouse shard.</li></ul> <p>So if you setup ClickHouse properly(ReplacingMergeTree ORDER BY (__kafak_topic, __kafka_partition, __kafka_offset)), you could get exactly-once semantic.</p> <p>It's hard for clickhouse_sinker to guarantee exactly-once semantic without ReplacingMergeTree. Kafka consumer group load-balance cause duplicated messages if one consumer crash suddenly.</p> <h3 id="sharding-with-kafka-message-offset-stripe-default"><a href="#sharding-with-kafka-message-offset-stripe-default" class="header-anchor">#</a> Sharding with kafka message offset stripe (default)</h3> <p>The flow is:</p> <ul><li>Fetch message via Franz, Sarama, or kafka-go, which starts internally a goroutine for each partition.</li> <li>Parse messages in a global goroutine pool(pool size is customizable), fill the result into a ring according to the message's partition and offset.</li> <li>Generate a batch when messages in a ring reach a batchSize boundary or flush timer fire. For each message, the dest shard is determined by <code>(kafka_offset/roundup(buffer_size))%clickhouse_shards</code>.</li> <li>Write batch to ClickHouse in a global goroutine pool(pool size is fixed according to the number of tasks and Clickhouse shards).</li></ul> <h3 id="sharding-with-custom-key"><a href="#sharding-with-custom-key" class="header-anchor">#</a> Sharding with custom key</h3> <p>The flow is:</p> <ul><li>Fetch message via kafka-go or samara, which starts internally a goroutine for each partition.</li> <li>Parse messages in a global goroutine pool(pool size is customizable), fill the result into a ring according to the message's partition and offset.</li> <li>Shard messages in a ring when messages reach a batchSize boundary or flush timer fire. For each message, if the sharding key is numerical(integer, float, time, etc.), the dest shard is determined by <code>(shardingKey/shardingStripe)%clickhouse_shards</code>, otherwise it is determined by <code>xxHash64(shardingKey)%clickhouse_shards</code>.</li> <li>Generate batches for all shard slots if messages in one shard slot reach batchSize boundary or flush timer fire. Those batches form a <code>BatchGroup</code>. The <code>before</code> relationship could be impossible if messages of a partition are distributed to multiple batches. So those batches need to be committed after ALL of them have been written to Clickhouse.</li> <li>Write batch to ClickHouse in a global goroutine pool(pool size is fixed according to the number of tasks and Clickhouse shards).</li></ul> <h2 id="task-scheduling"><a href="#task-scheduling" class="header-anchor">#</a> Task scheduling</h2> <p>The clickhouse-server configuration item <code>max_concurrent_queries</code>(default 100) is the maximum number of simultaneously processed queries related to MergeTree table. If the number of concurrent INSERT is close to <code>max_concurrent_queries</code>, the user queries(<code>SELECT</code>) could fail due to the limit.</p> <p>If the clickhouse-server is big, ingesting data to &gt;=100 MergeTree tables via clickhouse_sinker bring pressure to the Clickhouse cluster. On the other side, large number of clickhouse_sinker instances requires lots of CPU/MEM resources.</p> <p>The solution is, clickhouse_sinker instances coordinate with each other to assign tasks among themselves.</p> <p>The task scheduling procedure:</p> <ul><li>Some platform(Kubernetes, Yarn, etc.) start several clickhouse_sinker instances and may start/stop instances dynamically. Every clickhouse_sinker instance registers with Nacos as a single service(CLI option <code>--nacos-service-name</code>).</li> <li>Someone publish(add/delete/modify) a list of tasks(with empty assignment) to Nacos.</li> <li>The first clickhouse_sinker(per instance's ip+port) instance(named scheduler) is responsible to generate and publish task assignments regularly. The task list and assignment consist of the whole config. The task list change, service change, and task lag change will trigger another assignment. The scheduler ensures Each clickhouse_innker instance's total lag be balanced.</li> <li>Each clickhouse_sinker reloads the config regularly. This may start/stop tasks. clickhouse_sinker stops tasks gracefully so that there's no message lost/duplication during task transferring.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/clickhouse_sinker/dev/introduction.html" class="prev">
        Introduction
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/clickhouse_sinker/assets/js/app.8e568c59.js" defer></script><script src="/clickhouse_sinker/assets/js/3.8923746e.js" defer></script><script src="/clickhouse_sinker/assets/js/11.fb719bcf.js" defer></script>
  </body>
</html>
